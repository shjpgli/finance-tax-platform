<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.uc.mapper.db2.OrderExchangeRoMapper">

    <sql id="Base_Column_List">
        id, userId, orderNo, reason, adminRemark, userRemark, expressNo, expressComp, status, createTime, lastUpdate,
        toExpressNo, type
    </sql>

    <select id="selectList" parameterType="com.abc12366.uc.model.OrderExchange"
            resultType="com.abc12366.uc.model.OrderExchange">
        select e.id, e.userId, e.orderNo, e.name, q.imageUrl, q.goodsType, e.username, e.num, e.orderTime, e.type, e.reason, e.userRemark,
        e.expressNo, e.expressComp, e.toExpressNo, e.adminRemark, e.status, e.createTime, e.lastUpdate
        from (select c.*, d.productId, d.num, d.name from (select b.username, b.createTime as orderTime, a.* from uc_order_exchange a left join uc_order b on a.orderNo = b.orderNo) c
        left join uc_order_product d on c.orderNo = d.orderNo) e
        left join (select o.id, p.imageUrl, p.goodsType from uc_product o left join uc_goods p on o.goodsId = p.id) q
        on e.productId = q.id
        <where>
            <if test="type != null and type !=''">type = #{type}</if>
            <if test="status != null and status !=''">and status = #{status}</if>
            <if test="status != null and status !=''">and status = #{status}</if>
            <if test="lastUpdate != null and lastUpdate !=''">and lastUpdate >= #{lastUpdate}</if>
            <if test="userId != null and userId !=''">and userId = #{userId}</if>
            <if test="orderNo != null and orderNo !=''">and orderNo = #{orderNo}</if>
        </where>
        ORDER BY e.createTime DESC
    </select>

    <!-- 未完成换货申请，4-已完成 5-已拒绝 -->
    <select id="selectUndoneList" parameterType="java.lang.String"
            resultType="com.abc12366.uc.model.OrderExchange">
        SELECT <include refid="Base_Column_List"/>
        FROM uc_order_exchange
        WHERE orderNo = #{orderNo}
        AND status != '4'
        AND status != '5'
    </select>

    <select id="selectOne" parameterType="java.lang.String" resultType="com.abc12366.uc.model.OrderExchange">
        select e.id, e.orderNo, e.name, q.imageUrl, q.goodsType, e.username, e.num, e.orderTime, e.type, e.reason,
        e.userRemark, e.expressNo, e.expressComp, e.toExpressNo, e.adminRemark, e.status, e.createTime, e.lastUpdate
        from (select c.*, d.productId, d.num, d.name from (select b.username, b.createTime as orderTime, a.* from uc_order_exchange a left join uc_order b on a.orderNo = b.orderNo) c
        left join uc_order_product d on c.orderNo = d.orderNo) e
        left join (select o.id, p.imageUrl, p.goodsType from uc_product o left join uc_goods p on o.goodsId = p.id) q on e.productId = q.id
        WHERE e.id = #{id}
    </select>

    <select id="selectById" parameterType="java.lang.String" resultType="com.abc12366.uc.model.OrderExchange">
        SELECT <include refid="Base_Column_List"/>
        FROM uc_order_exchange
        WHERE id = #{id}
    </select>

    <select id="export" parameterType="com.abc12366.uc.model.bo.OrderExchangeExportBO"
            resultType="com.abc12366.uc.model.bo.SfExportBO">
        select h.orderNo, h.company, h.name, h.phone, h.address, j.name as content, 1 as num from (SELECT
        c.orderNo, d.name  as company, d.name, d.phone, concat(e.province, f.city, g.area, d.detail) as address
        FROM
        (SELECT
        b.*
        FROM
        uc_order_exchange a
        LEFT JOIN uc_order b ON a.orderNo = b.orderNo
        WHERE a.status = '6'
        and a.type = '1'
        and a.createTime <![CDATA[>=]]> DATE_FORMAT(#{startTime}, '%Y-%m-%d %H-%i-%s')
        and a.createTime <![CDATA[<=]]> DATE_FORMAT(#{endTime}, '%Y-%m-%d %H-%i-%s')) c,
        uc_user_address d,
        uc_province e,
        uc_city f,
        uc_area g
        WHERE
        c.addressId = d.id
        AND d.province = e.provinceId
        AND d.city = f.cityId
        AND d.area = g.areaId) h left join (select x.orderNo, x.name, y.specId from uc_order_product x left join uc_order_product_spec y on x.productId = y.productId) j on h.orderNo = j.orderNo
    </select>

    <select id="selectCompletedOrder" resultType="com.abc12366.uc.model.bo.ExchangeCompletedOrderBO"
            parameterType="java.lang.String">
        select orderNo, c.productId, goodsType, createTime, lastUpdate from
        (select a.orderNo, a.createTime, a.lastUpdate, b.productId from uc_order a left join uc_order_product b on a.orderNo = b.orderNo
        where a.orderStatus = '6') c
        left join
        (select o.id as productId, p.goodsType from uc_product o left join uc_goods p on o.goodsId = p.id) d on c.productId = d.productId
        where orderNo = #{orderNo}
    </select>

    <!-- 3-已拒绝 5-已退票 6-已收货-->
    <select id="selectOrderInvoice" parameterType="com.abc12366.uc.model.bo.ExchangeOrderInvoiceBO"
            resultType="com.abc12366.uc.model.bo.ExchangeOrderInvoiceBO">
        select c.invoiceNo, c.invoiceCode, c.name, c.content, c.amount, c.type, c.property, c.status,
        c.nsrsbh, c.nsrmc, c.address, c.phone, c.bank, d.isInvoice, d.orderNo from
        (select a.*, b.orderNo from uc_invoice a left join uc_order_invoice b on a.id = b.invoiceId) c
        left join uc_order d on c.orderNo = d.orderNo
        WHERE c.status <![CDATA[!=]]> '3' and c.status <![CDATA[!=]]> '5' and c.status <![CDATA[!=]]> '6'
        and c.orderNo = #{orderNo}
    </select>

    <select id="selectInvoice" parameterType="com.abc12366.uc.model.bo.ExchangeOrderInvoiceBO"
            resultType="com.abc12366.uc.model.bo.ExchangeOrderInvoiceBO">
        select c.invoiceNo, c.invoiceCode, c.name, c.content, c.amount, c.type, c.property, c.status,
        c.nsrsbh, c.nsrmc, c.address, c.phone, c.bank, d.isInvoice, d.orderNo from
        (select a.*, b.orderNo from uc_invoice a left join uc_order_invoice b on a.id = b.invoiceId) c
        left join uc_order d on c.orderNo = d.orderNo
        where c.status = '6'
        and c.orderNo = #{orderNo}
    </select>
</mapper>