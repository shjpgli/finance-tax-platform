<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.uc.mapper.db2.ActivityRoMapper">

    <!-- 通用查询结果列-->
    <sql id="Base_Column_List">
        id, name, description, startTime, endTime, ruleType, rule, amountType, amount,
        probability, status, wishing, remark, num, times, createTime, lastUpdate
    </sql>

    <sql id="Base_RedEnvelop_List">
        id, secret, createTime, activityId, startTime, endTime, amount, amountType, probability,
        sendAmount, sendStatus, sendTimes, sendTime, receiveStatus, receiveTime, ip, openId
    </sql>

    <sql id="Base_LotteryLog_List">
        id, secret, activityId, openId, createTime
    </sql>

    <select id="selectList" resultType="com.abc12366.uc.model.weixin.WxActivity"
            parameterType="com.abc12366.uc.model.weixin.WxActivity">
        SELECT
        <include refid="Base_Column_List"/>
        FROM uc_wxactivity
        <where>
            <if test="name != null and name != ''">name LIKE CONCAT('%',#{name},'%')</if>
        </where>
    </select>

    <select id="selectOne" resultType="com.abc12366.uc.model.weixin.WxActivity"
            parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM uc_wxactivity
        WHERE id = #{id}
    </select>

    <select id="selectRedEnvelopList" resultType="com.abc12366.uc.model.weixin.WxRedEnvelop"
            parameterType="com.abc12366.uc.model.weixin.WxRedEnvelop">
        SELECT
        <include refid="Base_RedEnvelop_List"/>
        FROM uc_wxredenvelop
        <where>
            <if test="activityId != null and activityId != ''">and activityId = #{activityId}</if>
            <if test="receiveStatus != null and receiveStatus != ''">and receiveStatus = #{receiveStatus}</if>
            <if test="sendStatus != null and sendStatus != ''">and sendStatus = #{sendStatus}</if>
            <if test="openId != null and openId != ''">and openId = #{openId}</if>
        </where>
    </select>

    <!-- 未抽奖记录 -->
    <select id="selectRedEnvelopOne" resultType="com.abc12366.uc.model.weixin.WxRedEnvelop"
            parameterType="java.lang.String">
        SELECT
        <include refid="Base_RedEnvelop_List"/>
        FROM uc_wxredenvelop
        WHERE id = #{id}
    </select>

    <!-- 未抽奖记录 -->
    <select id="selectRedEnvelop" resultType="com.abc12366.uc.model.weixin.WxRedEnvelop"
            parameterType="com.abc12366.uc.model.weixin.WxRedEnvelop">
        SELECT
        <include refid="Base_RedEnvelop_List"/>
        FROM uc_wxredenvelop
        <where>
            receiveStatus is null and sendStatus is null
            <if test="activityId != null and activityId != ''">and activityId = #{activityId}</if>
            <if test="secret != null and secret != ''">and secret = #{secret}</if>
        </where>
    </select>

    <!-- 查询某一活动已中奖数量 -->
    <select id="queryRedEnvelopCount" resultType="java.lang.Integer" parameterType="java.lang.String">
        SELECT count(id) FROM uc_wxredenvelop
        WHERE
        receiveStatus = '0'
        and receiveStatus = '1'
        and activityId = #{activityId}
    </select>

    <select id="selectSentReceivedCount" resultType="com.abc12366.uc.model.weixin.bo.redpack.SentReceived"
            parameterType="java.lang.String">
        SELECT activityId,
            sum(case when receiveStatus = 'SENT' then 1 else 0 end) as 'sent',
            sum(case when receiveStatus = 'SENT' then sendAmount else 0 end) as 'sentAmount',
            sum(case when receiveStatus = 'RECEIVED' then 1 else 0 end) as 'received',
            sum(case when receiveStatus = 'RECEIVED' then sendAmount else 0 end) as 'receivedAmount'
        FROM uc_wxredenvelop
        WHERE activityId = #{activityId}
    </select>

    <select id="selectLotteryLogList" parameterType="com.abc12366.uc.model.weixin.WxLotteryLog"
            resultType="com.abc12366.uc.model.weixin.WxLotteryLog">
        SELECT
        <include refid="Base_LotteryLog_List"/>
        FROM uc_wxlotterylog
        <where>
            <if test="activityId != null and activityId != ''">and activityId = #{activityId}</if>
            <if test="openId != null and openId != ''">and openId = #{openId}</if>
            <if test="createTime != null">and DATE_FORMAT(createTime, '%Y%m%d') = DATE_FORMAT(#{openId}, '%Y%m%d')</if>
        </where>
    </select>
</mapper>