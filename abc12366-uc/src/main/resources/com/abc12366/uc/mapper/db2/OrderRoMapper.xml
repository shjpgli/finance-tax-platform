<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.uc.mapper.db2.OrderRoMapper">

    <!--订单对象-->
    <resultMap id="orderBOResultMap" type="com.abc12366.uc.model.bo.OrderBO">
        <result column="orderNo" property="orderNo" jdbcType="VARCHAR"/>
        <result column="userId" property="userId" jdbcType="VARCHAR"/>
        <result column="orderStatus" property="orderStatus" jdbcType="VARCHAR"/>
        <result column="deliveryMethod" property="deliveryMethod" jdbcType="VARCHAR"/>
        <result column="payMethod" property="payMethod" jdbcType="VARCHAR"/>
        <result column="nowVipLevel" property="nowVipLevel" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="isShipping" property="isShipping" jdbcType="INTEGER"/>
        <result column="isFreeShipping" property="isFreeShipping" jdbcType="INTEGER"/>
        <result column="deliveryFee" property="deliveryFee" jdbcType="DOUBLE"/>
        <result column="isInsured" property="isInsured" jdbcType="INTEGER"/>
        <result column="insuredFee" property="insuredFee" jdbcType="DOUBLE"/>
        <result column="totalPrice" property="totalPrice" jdbcType="DOUBLE"/>
        <result column="addressId" property="addressId" jdbcType="VARCHAR"/>
        <result column="expressNo" property="expressNo" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="giftPoints" property="giftPoints" jdbcType="INTEGER"/>
        <result column="tradeMethod" property="tradeMethod" jdbcType="VARCHAR"/>
        <result column="isInvoice" property="isInvoice" jdbcType="TINYINT"/>
        <result column="cancelId" property="cancelId" jdbcType="VARCHAR"/>

        <association property="user" javaType="com.abc12366.uc.model.User">
            <id column="userId" property="id"/>
            <result column="username" property="username"/>
            <result column="nickname" property="nickname"/>
            <result column="phone" property="phone"/>
            <result column="vipLevel" property="vipLevel"/>
        </association>
        <association property="deliveryMethodBO" column="deliveryMethod" select="getDeliveryMethodBO"/>
        <association property="orderLogBO" column="orderNo" select="getOrderLogBO"/>
        <association property="invoiceBO" column="orderNo" select="getInvoiceBO"/>
        <collection property="orderProductBOList" ofType="com.abc12366.uc.model.bo.OrderProductBO" column="id"
                    select="getOrderProduct"></collection>
    </resultMap>

    <!--订单日志对象-->
    <resultMap id="orderLogMap" type="com.abc12366.uc.model.bo.OrderLogBO">
        <id column="orderLogId" property="id"/>
        <result column="orderNo" property="orderNo" jdbcType="VARCHAR"/>
        <result column="action" property="action" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="createUser" property="createUser" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!--发票对象-->
    <resultMap id="invoiceBOMap" type="com.abc12366.uc.model.bo.InvoiceBO">
        <id column="invoiceId" property="id" jdbcType="VARCHAR"/>
        <result column="userId" property="userId" jdbcType="VARCHAR"/>
        <result column="invoiceNo" property="invoiceNo" jdbcType="VARCHAR"/>
        <result column="invoiceCode" property="invoiceCode" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="compName" property="compName" jdbcType="VARCHAR"/>
        <result column="amount" property="amount" jdbcType="DOUBLE"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="property" property="property" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="nsrsbh" property="nsrsbh" jdbcType="VARCHAR"/>
        <result column="nsrmc" property="nsrmc" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="bank" property="bank" jdbcType="VARCHAR"/>
        <result column="addressId" property="addressId" jdbcType="VARCHAR"/>
        <result column="userOrderNo" property="userOrderNo" jdbcType="VARCHAR"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="deliveryMethod" property="deliveryMethod" jdbcType="VARCHAR"/>
        <result column="isShipping" property="isShipping" jdbcType="VARCHAR"/>
        <result column="isFreeShipping" property="isFreeShipping" jdbcType="VARCHAR"/>
        <result column="deliveryFee" property="deliveryFee" jdbcType="VARCHAR"/>
        <result column="isInsured" property="isInsured" jdbcType="VARCHAR"/>
        <result column="InsuredFee" property="InsuredFee" jdbcType="VARCHAR"/>
        <result column="payMethod" property="payMethod" jdbcType="VARCHAR"/>
    </resultMap>

    <!--配送方式对象-->
    <resultMap id="deliveryMethodBOMap" type="com.abc12366.uc.model.bo.DeliveryMethodBO">
        <id column="deliveryId" property="id"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="firstWeight" property="firstWeight" jdbcType="DOUBLE"/>
        <result column="firstWeightFee" property="firstWeightFee" jdbcType="DOUBLE"/>
        <result column="addedWeight" property="addedWeight" jdbcType="DOUBLE"/>
        <result column="addedWeightFee" property="addedWeightFee" jdbcType="DOUBLE"/>
        <result column="isInsured" property="isInsured" jdbcType="INTEGER"/>
        <result column="rate" property="rate" jdbcType="DOUBLE"/>
        <result column="minInsuredFee" property="minInsuredFee" jdbcType="DOUBLE"/>
        <result column="areaFeeType" property="areaFeeType" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!--获取配送方式-->
    <select id="getDeliveryMethodBO" resultMap="deliveryMethodBOMap" parameterType="java.lang.String">
        SELECT
        id as deliveryId, name, type, sort, status, description, createTime, lastUpdate, firstWeight, firstWeightFee,
        addedWeight, addedWeightFee, isInsured, rate, minInsuredFee, areaFeeType
        FROM uc_delivery_method
        WHERE id = #{deliveryMethod}
    </select>

    <!--获取发票信息-->
    <select id="getInvoiceBO" resultMap="invoiceBOMap" parameterType="java.lang.String">
        SELECT
        iv.id as invoiceId, iv.userId, iv.username, iv.invoiceNo, iv.invoiceCode, iv.name, iv.content, iv.compName,
        iv.amount, iv.type,
        iv.property, iv.status, iv.createTime, iv.lastUpdate, iv.nsrsbh, iv.nsrmc,
        iv.address, iv.phone, iv.bank, iv.addressId, iv.deliveryMethod, iv.isShipping, iv.isFreeShipping,
        iv.deliveryFee, iv.isInsured, iv.insuredFee, iv.payMethod
        FROM uc_invoice iv
        LEFT JOIN uc_order_invoice uoi ON uoi.invoiceId = iv.id
        WHERE uoi.orderNo = #{orderNo}
    </select>

    <!--获取订单日志-->
    <select id="getOrderLogBO" resultMap="orderLogMap" parameterType="java.lang.String">
        SELECT
        l.id as orderLogId, l.orderNo, l.action, l.createTime, l.createUser, l.remark
        FROM uc_order_log l
        WHERE l.orderNo = #{orderNo}
    </select>

    <!--用户对象-->
    <resultMap id="userBOMap" type="com.abc12366.uc.model.User">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="phone" property="phone"/>
        <result column="vipLevel" property="vipLevel"/>
    </resultMap>

    <!--订单和产品对应关系对象-->
    <resultMap id="orderProductBOMap" type="com.abc12366.uc.model.bo.OrderProductBO">
        <id column="orderNo" property="orderNo" jdbcType="VARCHAR"/>
        <result column="productId" property="productId" jdbcType="VARCHAR"/>
        <result column="sellingPrice" property="sellingPrice" jdbcType="DOUBLE"/>
        <result column="unitPrice" property="unitPrice" jdbcType="DOUBLE"/>
        <result column="num" property="num" jdbcType="INTEGER"/>
        <result column="discount" property="discount" jdbcType="DOUBLE"/>
        <result column="dealPrice" property="dealPrice" jdbcType="DOUBLE"/>
        <result column="name" property="name" jdbcType="INTEGER"/>
        <result column="categoryId" property="categoryId" jdbcType="VARCHAR"/>
        <result column="category" property="category" jdbcType="VARCHAR"/>
        <result column="weight" property="weight" jdbcType="DOUBLE"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <association property="productBO" javaType="com.abc12366.uc.model.bo.ProductBO" column="productId"
                     select="getProductBO"></association>
    </resultMap>

    <!--产品对象-->
    <resultMap type="com.abc12366.uc.model.bo.ProductBO" id="productResultMap">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="goodsId" property="goodsId" jdbcType="VARCHAR"/>
        <result column="marketPrice" property="marketPrice" jdbcType="DOUBLE"/>
        <result column="sellingPrice" property="sellingPrice" jdbcType="DOUBLE"/>
        <result column="costPrice" property="costPrice" jdbcType="DOUBLE"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="stock" property="stock" jdbcType="INTEGER"/>
        <result column="goodsName" property="goodsName" jdbcType="VARCHAR"/>
        <collection property="dictList" ofType="com.abc12366.uc.model.bo.DictBO" column="id"
                    select="getDictBO"></collection>
    </resultMap>

    <!--字典对象-->
    <resultMap type="com.abc12366.uc.model.bo.DictBO" id="oneDictBO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="dictId" property="dictId" jdbcType="VARCHAR"/>
        <result column="dictName" property="dictName" jdbcType="VARCHAR"/>
        <result column="fieldKey" property="fieldKey" jdbcType="VARCHAR"/>
        <result column="fieldValue" property="fieldValue" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="TINYINT"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="createUser" property="createUser" jdbcType="VARCHAR"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="lastUser" property="lastUser" jdbcType="VARCHAR"/>
        <result column="sort" property="sort" jdbcType="VARCHAR"/>
    </resultMap>

    <!--获取产品信息-->
    <select id="getProductBO" parameterType="java.lang.String" resultMap="productResultMap">
        SELECT
        id, goodsId, marketPrice, sellingPrice, costPrice, createTime, lastUpdate,stock
        FROM uc_product
        WHERE id = #{productId}
    </select>

    <!--获取字典信息-->
    <select id="getDictBO" parameterType="java.lang.String" resultMap="oneDictBO">
        SELECT
        d.id, d.dictId, d.dictName, d.fieldKey, d.fieldValue, d.status, d.createTime, d.createUser, d.lastUpdate,
        d.lastUser,d.sort
        FROM uc_view_sys_dict d
        LEFT JOIN uc_product_spec s ON s.specId = d.id
        WHERE s.productId = #{productId}
    </select>

    <!--获取产品和订单对应关系信息-->
    <select id="getOrderProduct" resultMap="orderProductBOMap" parameterType="java.lang.String">
        SELECT
        orderNo, productId, sellingPrice, unitPrice, num, discount, dealPrice, name, categoryId, category, weight,
        createTime, lastUpdate
        FROM uc_order_product
        WHERE orderNo = #{orderNo}
    </select>

    <!--获取用户信息-->
    <select id="getUser" resultMap="userBOMap" parameterType="java.lang.String">
        select id, username, phone,vipLevel
        from uc_user WHERE id = #{userId}
    </select>

    <!-- 通用查询结果列-->
    <sql id="Base_Column_List">
        id, orderNo, userId, orderStatus, deliveryMethod, payMethod, nowVipLevel, createTime, lastUpdate, username,
        isShipping, isFreeShipping, deliveryFee,
        isInsured, insuredFee, totalPrice, addressId, expressNo, remark,giftPoints,tradeMethod,isInvoice,cancelId
    </sql>


    <!-- 查询（根据主键ID查询） -->
    <select id="selectByPrimaryKey" resultType="com.abc12366.uc.model.Order" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM uc_order
        WHERE orderNo = #{orderNo}
    </select>

    <!-- 查询（根据主键ID查询） -->
    <select id="selectById" resultMap="orderBOResultMap" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        WHERE o.orderNo = #{orderNo}
    </select>

    <!-- 查询（根据主键ID和UserId查询） -->
    <select id="selectOrder" resultMap="orderBOResultMap" parameterType="com.abc12366.uc.model.Order">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        WHERE o.orderNo = #{orderNo} and o.userId = #{userId}
    </select>

    <!-- 通用BO查询结果列-->
    <sql id="Base_Column_BO_List">
        o.orderNo, o.userId, o.orderStatus, o.deliveryMethod, o.payMethod, o.nowVipLevel, o.createTime, o.lastUpdate,
        o.username, o.isShipping, o.isFreeShipping, o.deliveryFee,
        o.isInsured, o.insuredFee, o.totalPrice, o.addressId, o.expressNo,
        o.remark,o.giftPoints,o.tradeMethod,o.isInvoice,o.cancelId,u.id as
        userId,u.username,u.phone,u.vipLevel,u.nickname
    </sql>
    <!-- 后台查询（根据条件查询） -->
    <select id="selectList" resultMap="orderBOResultMap" parameterType="com.abc12366.uc.model.bo.OrderBO">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        <where>
            1 = 1
            <if test=" user.username != null and user.username != '' ">
                and u.username = #{user.username}
            </if>
            <if test=" orderStatus != null and orderStatus != '' ">
                and o.orderStatus = #{orderStatus}
            </if>
            <if test=" orderNo != null and orderNo != '' ">
                and o.orderNo = #{orderNo}
            </if>
            <if test="startTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') >= date_format(#{startTime}, '%Y-%m-%d')

                ]]>
            </if>
            <if test="endTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') <= date_format(#{endTime}, '%Y-%m-%d')
              ]]>
            </if>
        </where>

        order by o.lastUpdate desc

    </select>

    <select id="selectWaitList" resultMap="orderBOResultMap" parameterType="com.abc12366.uc.model.bo.OrderBO">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        <where>
            1 = 1
            <if test=" user.username != null and user.username != '' ">
                and u.username = #{user.username}
            </if>
            <!--<if test=" orderStatus != null and orderStatus != '' ">-->
            <!--<if test=" orderStatus != null and orderStatus != '' ">-->
            <!--and o.orderStatus = #{orderStatus}-->
            <!--</if>-->
            <!--</if>-->
            <if test=" orderNo != null and orderNo != '' ">
                and o.orderNo = #{orderNo}
            </if>
            <if test="startTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') >= date_format(#{startTime}, '%Y-%m-%d')

                ]]>
            </if>
            <if test="endTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') <= date_format(#{endTime}, '%Y-%m-%d')
              ]]>
            </if>
        </where>

        order by o.lastUpdate desc

    </select>

    <!-- 前台查询（根据条件查询） -->
    <select id="selectOrderList" resultMap="orderBOResultMap" parameterType="com.abc12366.uc.model.bo.OrderBO">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        <where>
            1 = 1
            <if test=" user.id != null and user.id != '' ">
                and u.id = #{user.id}
            </if>
            <if test=" orderStatus != null and orderStatus != '' ">
                and o.orderStatus = #{orderStatus}
            </if>
            <if test=" tradeMethod != null and tradeMethod != '' ">
                and o.tradeMethod = #{tradeMethod}
            </if>
            <if test=" isInvoice != null and isInvoice != '' ">
                and o.isInvoice = #{isInvoice}
            </if>
        </where>

        order by o.lastUpdate desc

    </select>

    <!-- 前台查询（根据条件查询） -->
    <select id="selectCartList" resultMap="orderBOResultMap" parameterType="com.abc12366.uc.model.bo.OrderBO">
        SELECT
        <include refid="Base_Column_BO_List"/>
        FROM uc_order o
        LEFT JOIN uc_user u ON u.id = o.userId
        <where>
            <if test=" orderStatus != null and orderStatus != '' ">
                o.orderStatus = #{orderStatus}
            </if>
        </where>

        order by o.lastUpdate desc

    </select>

</mapper>