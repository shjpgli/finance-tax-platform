<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.uc.mapper.db2.UserTaskRoMapper">

    <select id="selectList" resultType="com.abc12366.uc.model.bo.UserTaskBO" parameterType="java.util.Map">
        SELECT id,userId,taskId,status,createTime,lastUpdate
        from uc_user_task
        <where>
            <if test="id!=null">
                id=#{id}
            </if>
            <if test="id!=null">
                and id=#{id}
            </if>
        </where>
    </select>

    <select id="selectMyTask" parameterType="java.lang.String" resultType="com.abc12366.uc.model.bo.MyTaskBO">
        SELECT
        uu.points currentPoints,
        (SELECT SUM(uutt.award) FROM uc_user_task_todo uutt WHERE uutt.status=0 AND uutt.userId=uu.id and uutt.awardType = '1') unReceivePoints,
        NULL taskRange,
        (SELECT COUNT(1) finishedTaskCount FROM uc_user_task_todo uutt WHERE uutt.status=1 AND uutt.userId = uu.id AND
        uutt.createTime &gt;=(SELECT DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY)) AND uutt.createTime &lt; (SELECT
        DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL 1 MONTH))) finishedTaskCount
        FROM
        uc_user uu
        WHERE uu.id=#{userId}
    </select>

    <select id="selectTaskRangeList" resultType="com.abc12366.uc.model.bo.TaskRangeBO">
        SELECT a.userId,SUM(a.award) sumPoints
        FROM
        (SELECT uutt.userId,uutt.award
        FROM uc_user_task_todo uutt
        WHERE uutt.status=1
        AND uutt.createTime &gt;= (SELECT DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY))
        AND uutt.createTime &lt; (SELECT DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL 1 MONTH))
        ) a
        GROUP BY a.userId
        ORDER BY sumPoints DESC
    </select>

    <select id="selectMyTaskSurvey" parameterType="java.lang.String" resultType="com.abc12366.uc.model.MyTaskSurvey">

        SELECT
        (SELECT SUM(uutt.award)
        FROM uc_user_task_todo uutt
        WHERE uutt.userId=#{userId}
        AND uutt.status=1
        AND uutt.awardType='0'
        <![CDATA[
                AND uutt.createTime >=(SELECT DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY))
        ]]>
        <![CDATA[
                AND uutt.createTime < (SELECT DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL 1 MONTH))
        ]]>
        ) earnedExp,
        (SELECT SUM(uutt.award)
        FROM uc_user_task_todo uutt
        WHERE uutt.userId=#{userId}
        AND uutt.status=1
        AND uutt.awardType='1'
        <![CDATA[
                AND uutt.createTime >=(SELECT DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY))
        ]]>
        <![CDATA[
                AND uutt.createTime < (SELECT DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL 1 MONTH))
        ]]>
        )earnedPoint,
        (SELECT COUNT(1)
        FROM uc_user_task_todo uutt
        WHERE uutt.userId=#{userId}
        AND uutt.status=1
        <![CDATA[
                AND uutt.createTime >=(SELECT DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY))
        ]]>
        <![CDATA[
                AND uutt.createTime < (SELECT DATE_ADD(CURDATE() - DAY(CURDATE()) + 1, INTERVAL 1 MONTH))
        ]]>
        )completedTaskCount
        FROM DUAL
    </select>
</mapper>