<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.uc.mapper.db2.InvoiceRoMapper">

    <resultMap id="invoiceBOResultMap" type="com.abc12366.uc.model.bo.InvoiceBO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="userId" property="userId" jdbcType="VARCHAR"/>
        <result column="invoiceNo" property="invoiceNo" jdbcType="VARCHAR"/>
        <result column="invoiceCode" property="invoiceCode" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="compName" property="compName" jdbcType="VARCHAR"/>
        <result column="amount" property="amount" jdbcType="DOUBLE"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
        <result column="property" property="property" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="nsrsbh" property="nsrsbh" jdbcType="VARCHAR"/>
        <result column="nsrmc" property="nsrmc" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="bank" property="bank" jdbcType="VARCHAR"/>
        <result column="addressId" property="addressId" jdbcType="VARCHAR"/>
        <result column="userOrderNo" property="userOrderNo" jdbcType="VARCHAR"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="deliveryMethod" property="deliveryMethod" jdbcType="VARCHAR"/>
        <result column="isShipping" property="isShipping" jdbcType="VARCHAR"/>
        <result column="isFreeShipping" property="isFreeShipping" jdbcType="VARCHAR"/>
        <result column="deliveryFee" property="deliveryFee" jdbcType="VARCHAR"/>
        <result column="isInsured" property="isInsured" jdbcType="VARCHAR"/>
        <result column="InsuredFee" property="InsuredFee" jdbcType="VARCHAR"/>
        <result column="payMethod" property="payMethod" jdbcType="VARCHAR"/>

        <collection property="orderBOList" ofType="com.abc12366.uc.model.bo.OrderBO" column="id" select="getOrderBO"></collection>
    </resultMap>

    <resultMap id="oneOrderBOMap" type="com.abc12366.uc.model.bo.OrderBO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="orderNo" property="orderNo" jdbcType="VARCHAR"/>
        <result column="userId" property="userId" jdbcType="VARCHAR"/>
        <result column="orderStatus" property="orderStatus" jdbcType="VARCHAR"/>
        <result column="deliveryMethod" property="deliveryMethod" jdbcType="VARCHAR"/>
        <result column="payMethod" property="payMethod" jdbcType="VARCHAR"/>
        <result column="nowVipLevel" property="nowVipLevel" jdbcType="VARCHAR"/>
        <result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="lastUpdate" property="lastUpdate" jdbcType="TIMESTAMP"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="isShipping" property="isShipping" jdbcType="INTEGER"/>
        <result column="isFreeShipping" property="isFreeShipping" jdbcType="INTEGER"/>
        <result column="deliveryFee" property="deliveryFee" jdbcType="DOUBLE"/>
        <result column="isInsured" property="isInsured" jdbcType="INTEGER"/>
        <result column="insuredFee" property="insuredFee" jdbcType="DOUBLE"/>
        <result column="totalPrice" property="totalPrice" jdbcType="DOUBLE"/>
        <result column="addressId" property="addressId" jdbcType="VARCHAR"/>
        <result column="expressNo" property="expressNo" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="getOrderBO" resultMap="oneOrderBOMap" parameterType="java.lang.String">
        SELECT
        o.id,	o.orderNo,	o.userId,	o.orderStatus,	o.deliveryMethod,	o.payMethod,	o.nowVipLevel,	o.createTime,	o.lastUpdate,
        o.username,	o.isShipping,	o.isFreeShipping,	o.deliveryFee,	o.isInsured,	o.insuredFee,	o.totalPrice,	o.addressId,	o.expressNo,	o.remark
        FROM uc_order o
        LEFT JOIN uc_order_invoice uoi ON uoi.orderNo = o.orderNo
        WHERE uoi.invoiceId = #{invoiceId}
    </select>

    <!-- 通用查询结果列-->
    <sql id="Base_Column_List">
		 id,	userId,	username,	invoiceNo,	invoiceCode,	name,	content,	compName,	amount,	type,	property,	status,	createTime,	lastUpdate,	nsrsbh,	nsrmc,	address,	phone,	bank,	addressId,	deliveryMethod,	isShipping,	isFreeShipping,	deliveryFee,	isInsured,	insuredFee,	payMethod
	</sql>

    <!-- 查询（根据主键ID查询） -->
    <select id="selectById" resultMap="invoiceBOResultMap" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List" />
        FROM uc_invoice
        WHERE id = #{id}
    </select>

    <!-- 查询（根据userOrderNo查询） -->
    <select id="selectByUserOrderNo" resultType="com.abc12366.uc.model.Invoice" parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List" />
        FROM uc_invoice
        WHERE userOrderNo = #{userOrderNo}
    </select>

    <select id="selectAvailableInvoice" resultType="com.abc12366.uc.model.Invoice">
        SELECT
        <include refid="Base_Column_List" />
        FROM uc_invoice
        WHERE userOrderNo = #{userOrderNo}
    </select>


    <!-- 后台查询（根据条件查询） -->
    <select id="selectList" resultMap="invoiceBOResultMap" parameterType="com.abc12366.uc.model.bo.InvoiceBO">
        SELECT
        i.id,
        i.userId,
        i.invoiceNo,
        i.name,
        i.content,
        i.amount,
        i.type,
        i.property,
        i.status,
        i.createTime,
        i.lastUpdate,
        i.nsrsbh,
        i.nsrmc,
        i.address,
        i.phone,
        i.bank,
        i.addressId,
        i.userOrderNo,
        i.compName,
        u.username as username,
        a.name as consignee
        FROM uc_invoice i
        LEFT JOIN uc_user u ON u.id = i.userId
        LEFT JOIN uc_user_address a ON a.id = i.addressId
        <where>
            1 = 1
            <if test=" username != null and username != '' ">
                and u.username = #{username}
            </if>
            <if test=" consignee != null and consignee != '' ">
                and a.name = #{consignee}
            </if>
            <if test=" userOrderNo != null and userOrderNo != '' ">
                and i.userOrderNo = #{userOrderNo}
            </if>
            <if test=" invoiceNo != null and invoiceNo != '' ">
                and i.invoiceNo = #{invoiceNo}
            </if>
            <if test=" status != null and status != '' ">
                and i.status = #{status}
            </if>
            <if test="startTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') >= date_format(#{startTime}, '%Y-%m-%d')

                ]]>
            </if>
            <if test="endTime != null">
                <![CDATA[
              and date_format(o.createTime, '%Y-%m-%d') <= date_format(#{endTime}, '%Y-%m-%d')
              ]]>
            </if>
        </where>

        order by i.lastUpdate desc

    </select>

</mapper>