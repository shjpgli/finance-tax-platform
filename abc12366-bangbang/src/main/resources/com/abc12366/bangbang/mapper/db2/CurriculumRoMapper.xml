<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.abc12366.bangbang.mapper.db2.CurriculumRoMapper">

	<!-- 通用查询结果列-->
	<sql id="Base_Column_List">
		 curriculumId,title,browseNum,watchNum,classify,goodsId,	recommend,	teachingMethod,	trainTimeBegin,	trainTimeEnd,	isApply,	applyTimeBegin,	applyTimeEnd,	applyPay,	isSign,	signTimeBegin,	signTimeEnd,	issueTime,	peopleLimit,	trainSite,	cover,	label,	issueScope,	isFree,	originalPrice,	preferentialPrice,	integralOriginalPrice,	integralPreferentialPrice,	freeMember,	lecturerId,	lecturerName,	lecturerPicture,	curriculumidIntro,	status,	createrId,	createrName,	createrTime,	updateTime
	</sql>

	<!-- 查询（根据主键ID查询） -->
	<select id="selectByPrimaryKey" resultType="com.abc12366.bangbang.model.curriculum.Curriculum" parameterType="java.lang.String">
		 SELECT
             curriculumId,title,browseNum,watchNum,classify,cl.classifyName,goodsId,	recommend,	teachingMethod,	trainTimeBegin,	trainTimeEnd,	isApply,	applyTimeBegin,	applyTimeEnd,	applyPay,	isSign,	signTimeBegin,	signTimeEnd,	issueTime,	peopleLimit,	trainSite,	cover,	label,	issueScope,	isFree,	originalPrice,	preferentialPrice,	integralOriginalPrice,	integralPreferentialPrice,	freeMember,	lecturerId,	lecturerName,	lecturerPicture,	curriculumidIntro,	status,	createrId,	createrName,	createrTime,	updateTime
        FROM bb_curriculum c LEFT JOIN bb_curriculum_classify cl ON c.classify = cl.classifyId
		 WHERE curriculumId = #{curriculumId}
	</select>

    <!-- 查询（根据主键ID查询） -->
    <select id="selectList" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListBo" parameterType="java.util.Map">
        SELECT
          curriculumId,title,browseNum,watchNum,cover,cl.classifyName classify,teachingMethod,issueTime,isFree,status,createrName,updateTime
        FROM bb_curriculum c LEFT JOIN bb_curriculum_classify cl ON c.classify = cl.classifyId
        WHERE 1=1
        <if test="title != null and title != ''">
            AND title like CONCAT('%',#{title},'%')
        </if>
        <if test="label != null and label != ''">
            AND label like CONCAT('%',#{label},'%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="classify != null and classify != ''">
            AND classify = #{classify}
        </if>
    </select>

    <!-- 查询最新课程 -->
    <select id="selectListNew" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListsyBo" parameterType="java.util.Map">
        SELECT
        curriculumId,title,browseNum,watchNum,goodsId,cover,issueTime,isFree,freeMember,curriculumidIntro,
        (select count(coursewareId) from bb_curriculum_courseware where curriculumId = c.curriculumId) coursewareNum
        FROM bb_curriculum c
        WHERE 1=1 and status = 1
        <if test="label != null and label != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_label where labelId = #{label})
        </if>
        <if test="classify != null and classify != ''">
            AND classify = #{classify}
        </if>
        <if test="freeMember != null and freeMember != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_membergrade where memberGrade = #{freeMember})
        </if>
        <if test="isFree != null and isFree != ''">
            AND isFree = #{isFree}
        </if>
        ORDER BY issueTime DESC
    </select>

    <!-- 查询热播课程 -->
    <select id="selectListWatch" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListsyBo" parameterType="java.util.Map">
        SELECT
        curriculumId,title,browseNum,watchNum,goodsId,cover,issueTime,isFree,freeMember,curriculumidIntro,
        (select count(coursewareId) from bb_curriculum_courseware where curriculumId = c.curriculumId) coursewareNum
        FROM bb_curriculum c
        WHERE 1=1 and status = 1
        <if test="label != null and label != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_label where labelId = #{label})
        </if>
        <if test="classify != null and classify != ''">
            AND classify = #{classify}
        </if>
        <if test="freeMember != null and freeMember != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_membergrade where memberGrade = #{freeMember})
        </if>
        <if test="isFree != null and isFree != ''">
            AND isFree = #{isFree}
        </if>
        ORDER BY watchNum,issueTime DESC
    </select>

    <!-- 查询推荐课程 -->
    <select id="selectRecommend" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListsyBo" parameterType="java.lang.String">
        SELECT
        curriculumId,title,browseNum,watchNum,goodsId,cover,issueTime,isFree,freeMember,curriculumidIntro,
        (select count(coursewareId) from bb_curriculum_courseware where curriculumId = c.curriculumId) coursewareNum
        FROM bb_curriculum c
        WHERE 1=1 and status = 1 and recommend = 1
        <if test="label != null and label != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_label where labelId = #{label})
        </if>
        <if test="classify != null and classify != ''">
            AND classify = #{classify}
        </if>
        <if test="freeMember != null and freeMember != ''">
            AND curriculumId in (select curriculumId from bb_curriculum_membergrade where memberGrade = #{freeMember})
        </if>
        <if test="isFree != null and isFree != ''">
            AND isFree = #{isFree}
        </if>
    </select>

    <!-- 查询授课情况 -->
    <select id="selectSituation" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumSituationBo" parameterType="java.lang.String">
        SELECT
            curriculumId,title,browseNum,watchNum,teachingMethod,peopleLimit,applyTimeBegin,applyTimeEnd,signTimeBegin,signTimeEnd,
            (SELECT ifnull(sum(orderId),0) FROM cms_curriculum_order where curriculumId = c.curriculumId) orderNum,
            (SELECT ifnull(sum(orderPrice),0) FROM cms_curriculum_order where curriculumId = c.curriculumId) generalIncome,
            (SELECT ifnull(sum(orderIntegral),0) FROM cms_curriculum_order where curriculumId = c.curriculumId) aggregateScore,
			(SELECT ifnull(sum(applyId),0) FROM cms_curriculum_apply where curriculumId = c.curriculumId) applyNum,
            (SELECT ifnull(sum(applyId),0) FROM cms_curriculum_apply where curriculumId = c.curriculumId and signTime is not null) signNum
        FROM bb_curriculum c
        WHERE curriculumId = #{curriculumId}
    </select>

    <!-- 查询课程信息(前端用) -->
    <select id="selectCurriculum" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumsyBo" parameterType="java.lang.String">
        SELECT
        curriculumId,title,browseNum,watchNum,goodsId,issueTime,cover,isFree,curriculumidIntro,
        trainTimeBegin,trainTimeEnd,isApply,peopleLimit,applyTimeBegin,applyTimeEnd,applyPay,isSign,signTimeBegin,signTimeEnd,
        (SELECT count(evaluateId) FROM bb_curriculum_evaluate where curriculumId =c.curriculumId) evaluateNum,
            (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade in(4,5) and curriculumId =c.curriculumId) evaluateNum45,
            (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade in(2,3) and curriculumId =c.curriculumId) evaluateNum23,
            (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade = 1 and curriculumId =c.curriculumId) evaluateNum1
        FROM bb_curriculum c
        WHERE curriculumId = #{curriculumId}
    </select>

    <!-- 查询课程评价统计信息(前端用) -->
    <select id="selectEvaluateTj" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumEvaluateTjBo" parameterType="java.lang.String">
        SELECT
        (SELECT count(evaluateId) FROM bb_curriculum_evaluate where curriculumId =c.curriculumId) evaluateNum,
        (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade in(4,5) and curriculumId =c.curriculumId) evaluateNum45,
        (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade in(2,3) and curriculumId =c.curriculumId) evaluateNum23,
        (SELECT count(evaluateId) FROM bb_curriculum_evaluate where grade = 1 and curriculumId =c.curriculumId) evaluateNum1
        FROM bb_curriculum c
        WHERE curriculumId = #{curriculumId}
    </select>

    <!-- 查询相关课程 -->
    <select id="selectListxgNew" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListsyBo" parameterType="java.lang.String">
        SELECT
        curriculumId,title,browseNum,watchNum,goodsId,cover,issueTime,isFree,freeMember,curriculumidIntro
        FROM bb_curriculum
        WHERE 1=1 and status = 1 and curriculumId != #{curriculumId}
            AND curriculumId in (select curriculumId from bb_curriculum_label where labelId in(select labelId from bb_curriculum_label where curriculumId = #{curriculumId}))
        ORDER BY issueTime DESC limit 4
    </select>

    <!-- 查询课程学习历史 -->
    <select id="selectStudyHistory" resultType="com.abc12366.bangbang.model.curriculum.bo.CurrMyStudyBo" parameterType="java.util.Map">
        select s.curriculumId,s.userId,orderTime,orderPrice,orderIntegral,isIntegral,orderStatus,c.title,c.cover,c.isFree,
            (select studyTime from bb_curriculum_study where curriculumId = s.curriculumId order by studyTime desc limit 1) studyTime,
            (select coursewareId from bb_curriculum_study where curriculumId = s.curriculumId order by studyTime desc limit 1) coursewareId
            from (SELECT curriculumId,userId FROM bb_curriculum_study group by curriculumId,userId order by studyTime desc) s
            left join bb_curriculum_order o on (s.curriculumId = o.curriculumId and s.userId = o.userId)
            left join bb_curriculum c on s.curriculumId = c.curriculumId
        WHERE 1=1
        <if test="userId != null and userId != ''">
            AND s.userId = #{userId}
        </if>
    </select>

    <!-- 查询收藏课程 -->
    <select id="selectListCollect" resultType="com.abc12366.bangbang.model.curriculum.bo.CurriculumListsyBo" parameterType="java.util.Map">
        SELECT
        col.curriculumId,title,browseNum,watchNum,goodsId,cover,issueTime,isFree,freeMember,curriculumidIntro,
        (select count(coursewareId) from bb_curriculum_courseware where curriculumId = c.curriculumId) coursewareNum
        FROM bb_curriculum_collect col left join bb_curriculum c on col.curriculumId = c.curriculumId
        WHERE 1=1
        <if test="userId != null and userId != ''">
            AND col.userId = #{userId}
        </if>
        ORDER BY collectTime DESC
    </select>


</mapper>